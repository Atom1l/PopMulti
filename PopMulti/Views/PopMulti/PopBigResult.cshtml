@model PopMulti.Models.PopModel.PopMultiModel
@{
    Layout = "_Poplayout";
}
<link rel="stylesheet" href="/css/PopMulti.css" asp-append-version="true" />

<div class="section-popup d-flex justify-content-center align-items-center">
    <canvas class="canvas p-3" id="bar"></canvas>
</div>

<!-- Script for Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/microsoft/signalr@5.0.11/dist/browser/signalr.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
<script type="text/javascript">
    // Get canvas context for chart on the result page
    var chart = document.getElementById('bar').getContext('2d');
    var mychart = new Chart(chart, {
        type: 'bar',
        data: {
            labels: ['KMUTT', 'SU', 'SWU'],
            datasets: [{
                label: 'Pop-Multi Scores',
                data: [@Model.KMUTT, @Model.SU, @Model.SWU], // Replace with valid numeric data
                backgroundColor: ['rgba(240,78,35,0.5)', 'rgba(0,116,104,0.5)', 'rgba(218,33,39,0.5)'],
                borderColor: ['rgba(240,78,35,1)', 'rgba(0,116,104,1)', 'rgba(218,33,39,1)'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true, // Keeps chart responsive
            plugins: {
                legend: {
                    labels: {
                        font: {
                            size: function (context) {
                                // Dynamically calculate font size based on chart width
                                let width = context.chart.width;
                                return width < 500 ? 12 : 30; // Smaller font for smaller screens
                            }
                        }
                    }
                },
                tooltip: {
                    bodyFont: {
                        size: function (context) {
                            let width = context.chart.width;
                            return width < 500 ? 10 : 26;
                        }
                    },
                    titleFont: {
                        size: function (context) {
                            let width = context.chart.width;
                            return width < 500 ? 12 : 28;
                        }
                    }
                }
            },
            scales: {
                x: {
                    ticks: {
                        font: {
                            size: function (context) {
                                let width = context.chart.width;
                                return width < 500 ? 10 : 26; // Adjust font size based on width
                            }
                        }
                    }
                },
                y: {
                    ticks: {
                        font: {
                            size: function (context) {
                                let width = context.chart.width;
                                return width < 500 ? 10 : 26; // Adjust font size based on width
                            }
                        },
                        beginAtZero: true
                    }
                }
            }
        }
    });

    // Setup SignalR connection on the result page
    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/scoreHub")
        .build();

    // Start the connection
    connection.start()
        .then(() => console.log("Connected to SignalR")) // If successfully connected will show in console log with this line //
        .catch(err => console.error("SignalR Connection Error: ", err));

    // Listen for score updates
    connection.on("ReceiveScoreUpdate", function (university, newScore) {
        if (university === "KMUTT") { // Update real-time score for KMUTT
            mychart.data.datasets[0].data[0] = newScore; // KMUTT is at index 0 in dataset
        }
        else if (university === "SU") { // Update real-time score for SU
            mychart.data.datasets[0].data[1] = newScore;
        }
        else if (university === "SWU") { // Update real-time score for SWU
            mychart.data.datasets[0].data[2] = newScore;
        }

        // Update the chart with the new data( Scores update )
        mychart.update();
    });
</script>